# Instructions

- You are a helpful ai assistant
- Your job is to write IT corporate style documentation for the given project
- Brief steps will be provided to you. You have to convert it into professional guide with step by step navigation included with reference links for software developers.
- Do not generate any code, I already have the required code. Leave a placeholder to insert code and reference images wherever required.

# Project

## Overview

Agent to Agent communication between Salesforce Agentforce and Microsoft Copilot Studio Agent with data security and role based access control.

- Salesforce Named Credentials for user authentication with microsoft.
- Express js server for invoking copilot agent through Microsoft Agents SDK using the credentials passed by salesforce.
- Microsoft Copilot Studio Agent with access to SharePoint sites as knowledge.

## Procedure

## Create a new User in Azure

- Create a new member user

### Copilot Studio Agent Creation

- Create an agent in copilot studio
- Copy the environment id, schema name, app id and tenant id for further use.
- Share the Copilot Studio Agent with the previously created user as viewer.

### App Registration

- Register a new app or use the existing one
- Create a client secret
- Copy the client id, tenant id and secret for further use
- give the following api permissions:
	- openid
	- offline_access
	- delegated -> Sites.Read.All
	- delegated -> CopilotStudio.Copilots.Invoke
- If Power Platform API not available, run the given powershell command to enable it.

### Auth Provider

- Create a new auth provider in salesforce
- provide the client id and secret copied before in Consumer key and consumer secret
- Provide the endpoint and token url.
- copy the callback url and paste in App Registration -> Authentication -> Redirect URI

### External Credentials

- Create a new external credential using previously created auth provided.
- Add and authenticate the following Principals:
	- https://api.powerplatformapi.com/.default
	- https://graph.microsoft.com/.default
- The microsoft account used to authenticate the principals will be used to invoke the copilot agent and will have role based access to SharePoint and other microsoft resources.

### Named Credentials

- Create new named credential using previously created external credential
- In the URL field give the URL of the Express js server

### Apex Code

- use apex code to send http request to Express js server.
- use named credential callout which automatically injects the user access token into the header.
- make the sure the apex method is @InvocableMethod to be used as Agent Action.

### Express js Server

- this server uses Microsoft Agents SDK to invoke Copilot Studio Agent with using the access token sent by salesforce apex request.
- Make sure the server endpoint is added in the salesforce remote site settings.
- Add the server URI in App Registration -> Authentication -> Redirect URI
